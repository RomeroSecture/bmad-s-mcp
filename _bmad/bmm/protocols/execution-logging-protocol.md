# BMAD-S Execution Logging Protocol (ELP)

## Purpose

Every agent MUST log its execution TWICE: once at the START and once at the END
of every workflow run. This creates a traceable history of what happened, when,
who did it, and whether it succeeded — and critically, it detects interrupted
executions that never completed (orphan entries).

## Log Location

```
_bmad-output/execution-log.yaml
```

This file is **append-only**. Agents NEVER overwrite or delete existing entries.
If the file doesn't exist, create it with the header below.

## File Header (create once)

```yaml
# BMAD-S Execution Log
# This file is append-only. Agents add entries at the end.
# Do NOT manually edit or delete entries.
# Generated by BMAD-S Execution Logging Protocol (ELP)

entries: []
```

## Two-Phase Logging

### Phase 1: STARTED (at the beginning)

Immediately AFTER completing the VRG gate (Step 0) and BEFORE starting Step 1,
the agent MUST append a STARTED entry:

```yaml
  - id: "<YYYYMMDD-HHMMSS>-<agent_name>-<trigger>"
    timestamp: "<ISO 8601: YYYY-MM-DDTHH:MM:SS>"
    agent: "<agent_name>"
    trigger: "<trigger_code>"
    workflow: "<workflow_name>"
    mode: "<VERIFY | REFINE | GENERATE>"
    result: "STARTED"
    summary: "<what the agent is about to do>"
```

The STARTED entry is intentionally minimal — just enough to know what was
attempted. It uses the SAME `id` that the closing entry will use.

### Phase 2: Closing entry (at the end)

At the END of every workflow execution (success, failure, partial, or halt),
the agent MUST append a full closing entry:

```yaml
  - id: "<SAME id as the STARTED entry>"
    timestamp: "<ISO 8601: YYYY-MM-DDTHH:MM:SS>"
    agent: "<agent_name>"
    trigger: "<trigger_code>"
    workflow: "<workflow_name>"
    mode: "<VERIFY | REFINE | GENERATE>"
    result: "<SUCCESS | PARTIAL | FAILED | HALTED>"
    duration_estimate: "<approximate time from STARTED to now>"
    summary: "<1-2 sentence description of what was done>"
    artifacts_created:
      - "<path to file created>"
    artifacts_modified:
      - "<path to file modified>"
    errors: []
    next_recommended: "<suggested next action>"
```

### Orphan Detection

A STARTED entry without a matching closing entry (same `id`) is an **orphan**.
This means the workflow was interrupted — context window overflow, crash,
user closed the chat, or network failure.

The dashboard detects orphans by scanning for STARTED entries whose `id`
does not appear in any subsequent closing entry.

## Result Definitions

| Result | Meaning | When written |
|--------|---------|-------------|
| **STARTED** | Workflow has begun execution | After VRG gate, before Step 1 |
| **SUCCESS** | All steps completed, all objectives met | At the end |
| **PARTIAL** | Some steps completed, but workflow did not finish entirely | At the end |
| **FAILED** | A critical step failed — artifacts may be incomplete | At the end |
| **HALTED** | Workflow stopped intentionally (missing MCP, prerequisite, user cancelled) | At the end |

Note: HALTED can be written INSTEAD of STARTED when the workflow stops at Step 0
(e.g., MCP check fails). In this case there is no STARTED because the workflow
never really began — the halt IS the only entry.

## Error Detail Format

When result is FAILED or PARTIAL, the `errors` field MUST contain at least one entry:

```yaml
    errors:
      - step: "step-02-create-and-configure"
        action: "Create branch protection on main"
        error: "GitHub MCP returned 403: insufficient permissions"
        context: "Token has 'repo' scope but missing 'admin:org' for branch protection on org repos"
        recovery: "Regenerate GitHub PAT with 'admin:org' scope at https://github.com/settings/tokens"
        severity: "blocking"  # blocking | degraded | cosmetic
```

Severity levels:
- **blocking**: Cannot continue. Core objective not met.
- **degraded**: Workflow completed but with missing functionality.
- **cosmetic**: Minor issue, everything works.

## Examples

### Complete lifecycle: STARTED → SUCCESS
```yaml
  - id: "20260214-143000-milhouse-GR"
    timestamp: "2026-02-14T14:30:00"
    agent: "Milhouse"
    trigger: "GR"
    workflow: "configure-repo"
    mode: "GENERATE"
    result: "STARTED"
    summary: "Configuring new GitHub repository for Denarius web project"

  - id: "20260214-143000-milhouse-GR"
    timestamp: "2026-02-14T14:38:22"
    agent: "Milhouse"
    trigger: "GR"
    workflow: "configure-repo"
    mode: "GENERATE"
    result: "SUCCESS"
    duration_estimate: "8 minutes"
    summary: "Created repository denarius/web on GitHub with Git Flow branching, branch protection on main and develop, enhanced .gitignore for Angular"
    artifacts_created:
      - "docs/project/repository-setup.md"
    artifacts_modified: []
    errors: []
    next_recommended: "Homer, DS — start implementing stories"
```

### Complete lifecycle: STARTED → PARTIAL (interrupted by error)
```yaml
  - id: "20260214-130000-homer-DS"
    timestamp: "2026-02-14T13:00:00"
    agent: "Homer"
    trigger: "DS"
    workflow: "dev-story"
    mode: "GENERATE"
    result: "STARTED"
    summary: "Implementing story 1-2-home-page (5 tasks)"

  - id: "20260214-130000-homer-DS"
    timestamp: "2026-02-14T13:45:00"
    agent: "Homer"
    trigger: "DS"
    workflow: "dev-story"
    mode: "GENERATE"
    result: "PARTIAL"
    duration_estimate: "45 minutes"
    summary: "Story 1-2-home-page: 3/5 tasks completed. Test fails on task 4."
    artifacts_created: []
    artifacts_modified:
      - "_bmad-output/implementation-artifacts/stories/1-2-home-page.md"
    errors:
      - step: "task-4-contact-form"
        action: "Run tests for email validation"
        error: "Test email validation fails: expected true, got false"
        context: "Regex does not accept .es domains"
        recovery: "Fix regex in validators/email.ts and re-run Homer, DS"
        severity: "blocking"
    next_recommended: "Homer, DS — fix regex and retry"
```

### Orphan: STARTED with no closing entry
```yaml
  - id: "20260214-160000-homer-DS"
    timestamp: "2026-02-14T16:00:00"
    agent: "Homer"
    trigger: "DS"
    workflow: "dev-story"
    mode: "REFINE"
    result: "STARTED"
    summary: "Retrying story 1-2-home-page after regex fix (2 remaining tasks)"

  # ← No closing entry. Session was interrupted.
  #   Dashboard will flag this as an orphan execution.
```

### Halted at Step 0 (no STARTED needed)
```yaml
  - id: "20260214-110000-milhouse-GR"
    timestamp: "2026-02-14T11:00:00"
    agent: "Milhouse"
    trigger: "GR"
    workflow: "configure-repo"
    mode: "GENERATE"
    result: "HALTED"
    duration_estimate: "1 minute"
    summary: "Cannot proceed — GitHub MCP not configured"
    artifacts_created: []
    artifacts_modified: []
    errors:
      - step: "step-0-mcp-check"
        action: "Verify GitHub MCP availability"
        error: "GitHub MCP Server not available"
        context: "No MCP configuration found in .cursor/mcp.json for GitHub"
        recovery: "Run 'Smithers, SM' to configure GitHub MCP"
        severity: "blocking"
    next_recommended: "Smithers, SM — configure GitHub MCP"
```

## Integration with Agents

This protocol applies to ALL agents. The agent MUST write to the log at two points:

### Point 1: After VRG gate, before Step 1
1. Read the existing `_bmad-output/execution-log.yaml` (create if absent)
2. Append a STARTED entry with: id, timestamp, agent, trigger, workflow, mode, summary
3. Write the updated file
4. Proceed to Step 1

### Point 2: At the end of the workflow, before showing final menu
1. Read the existing `_bmad-output/execution-log.yaml`
2. Append a closing entry (SUCCESS/PARTIAL/FAILED) with full details
3. Write the updated file
4. Show the final menu to the user

### Exception: HALTED at Step 0
If the workflow halts at Step 0 (MCP check, missing prerequisite), write a single
HALTED entry — no STARTED needed because the workflow never began.

### If the log file cannot be written
Print the entry in the conversation so the user can save it manually.

## Reading the Log

Any agent can read the execution log to understand project history.
This is especially useful for:

- **Dashboard generation**: Aggregate all entries for a summary
- **Orphan detection**: Find STARTED entries without matching closing entries
- **Error recovery**: Find the last failed entry and its recovery steps
- **Context for new sessions**: An agent starting fresh can read the log
  to understand what happened before
- **Sprint retrospectives**: What was done, how long things took, what failed
